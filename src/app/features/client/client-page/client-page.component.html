<div class="min-h-screen bg-gray-50 p-6">

    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center items-center h-64">
        <div
            class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading"
        class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <div class="flex">
            <i
                class="fa-solid fa-triangle-exclamation text-red-400 mr-3 mt-1"></i>
            <div>
                <h3 class="text-red-800 font-medium">Erreur de chargement</h3>
                <p class="text-red-600 text-sm mt-1">{{ error }}</p>
                <button (click)="refreshData()"
                    class="mt-2 text-sm bg-red-100 hover:bg-red-200 text-red-800 px-3 py-1 rounded">
                    Réessayer
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div *ngIf="!loading">

        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                Bonjour, {{ clientName }}
            </h1>
            <p class="text-gray-600">{{ formatDate(currentDate) }}</p>
        </div>

        <!-- Financial Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div
                class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Solde
                            total</p>
                        <p class="text-2xl font-bold text-gray-900">{{
                            formatCurrency(summary.totalBalance) }}</p>
                    </div>
                    <div
                        class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fa-solid fa-wallet text-blue-600"></i>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Revenus
                            mensuels</p>
                        <p class="text-2xl font-bold text-gray-900">{{
                            formatCurrency(summary.monthlyIncome) }}</p>
                    </div>
                    <div
                        class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
                        <i
                            class="fa-solid fa-arrow-trend-up text-green-600"></i>
                    </div>
                </div>
            </div>

            <div
                class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Dépenses
                            mensuelles</p>
                        <p class="text-2xl font-bold text-gray-900">{{
                            formatCurrency(summary.monthlyExpenses) }}</p>
                    </div>
                    <div
                        class="h-12 w-12 bg-red-100 rounded-lg flex items-center justify-center">
                        <i
                            class="fa-solid fa-arrow-trend-down text-red-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cards Section -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Mes cartes</h2>
                <button (click)="refreshData()"
                    class="text-blue-600 hover:text-blue-800 transition-colors">
                    <i class="fa-solid fa-rotate-right mr-2"></i>
                    Actualiser
                </button>
            </div>

            <!-- Cards Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- Existing Cards -->
                <div *ngFor="let card of cards"
                    [class]="card.cardBackground"
                    class="relative p-6 rounded-2xl text-white shadow-xl transform hover:scale-105 transition-all duration-300">

                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <p class="text-sm opacity-80">{{ card.type ===
                                'credit' ? 'Carte de crédit' : 'Carte de débit'
                                }}</p>
                            <p
                                class="text-xs opacity-60 uppercase tracking-wider">{{
                                card.network }}</p>
                        </div>
                        <div class="flex space-x-2">
                            <div *ngIf="card.isContactless"
                                class="w-6 h-6 border border-white rounded-full flex items-center justify-center">
                                <i class="fa-solid fa-wifi text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <p class="text-xl font-mono tracking-wider">{{
                            card.maskedNumber }}</p>
                    </div>

                    <div class="flex justify-between items-end">
                        <div>
                            <p
                                class="text-xs opacity-60 uppercase">Titulaire</p>
                            <p class="font-medium">{{ card.cardholderName }}</p>
                        </div>
                        <div>
                            <p class="text-xs opacity-60 uppercase">Expire</p>
                            <p class="font-medium">{{ card.expiryDate }}</p>
                        </div>
                    </div>

                    <div class="absolute bottom-4 right-4">
                        <span [class]="getStatusClass(card.status)"
                            class="px-2 py-1 rounded-full text-xs font-medium">
                            {{ card.status === 'active' ? 'Active' : card.status
                            }}
                        </span>
                    </div>
                </div>

                <!-- Add Card Button -->
                <div
                    class="relative p-6 rounded-2xl border-2 border-dashed border-gray-300 bg-gray-50 hover:bg-gray-100 transition-colors duration-300 cursor-pointer flex flex-col items-center justify-center min-h-[200px]"
                    (click)="openCardRequestModal()">
                    <div class="text-center">
                        <i
                            class="fa-solid fa-plus text-4xl text-gray-400 mb-4"></i>
                        <h3
                            class="text-lg font-semibold text-gray-700 mb-2">Demander
                            une carte</h3>
                        <p class="text-sm text-gray-500">
                            Cliquez pour faire une demande<br>
                            de nouvelle carte bancaire
                        </p>
                    </div>
                </div>

            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-gray-900">Transactions
                    récentes</h2>
                <button (click)="toggleAllTransactions()"
                    class="text-blue-600 hover:text-blue-800 transition-colors text-sm">
                    {{ showAllTransactions ? 'Voir moins' : 'Voir tout' }}
                </button>
            </div>

            <div class="space-y-4">
                <div
                    *ngFor="let transaction of (showAllTransactions ? transactions : transactions.slice(0, 5))"
                    class="flex items-center justify-between p-4 hover:bg-gray-50 rounded-lg transition-colors">

                    <div class="flex items-center space-x-4">
                        <div
                            class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                            <i [class]="'fa-solid fa-' + transaction.icon"
                                class="text-gray-600"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">{{
                                transaction.name }}</p>
                            <p class="text-sm text-gray-500">{{
                                transaction.merchant }}</p>
                        </div>
                    </div>

                    <div class="text-right">
                        <p
                            [class]="transaction.amount > 0 ? 'text-green-600' : 'text-red-600'"
                            class="font-medium">
                            {{ transaction.amount > 0 ? '+' : '' }}{{
                            formatCurrency(transaction.amount,
                            transaction.currency) }}
                        </p>
                        <div class="flex items-center space-x-2">
                            <span [class]="getStatusClass(transaction.status)"
                                class="px-2 py-1 rounded-full text-xs font-medium">
                                {{ transaction.status === 'completed' ?
                                'Complété' :
                                transaction.status === 'pending' ? 'En attente'
                                : transaction.status }}
                            </span>
                            <span class="text-xs text-gray-500">{{
                                formatDate(transaction.date) }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Card Request Modal -->
    <div *ngIf="showCardRequestModal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">

        <div
            class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">

            <!-- Header -->
            <div
                class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-xl font-semibold text-gray-900">
                    <i class="fa-solid fa-credit-card mr-2 text-blue-600"></i>
                    Demande de carte
                </h2>
                <button (click)="closeCardRequestModal()"
                    class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                </button>
            </div>

            <!-- Form -->
            <form (ngSubmit)="submitCardRequest()" class="p-6 space-y-4">

                <!-- Success Message -->
                <div *ngIf="cardRequestSuccess"
                    class="bg-green-50 border border-green-200 rounded-lg p-3 text-green-800">
                    <i class="fa-solid fa-check-circle mr-2"></i>
                    {{ cardRequestSuccess }}
                </div>

                <!-- Error Message -->
                <div *ngIf="cardRequestError"
                    class="bg-red-50 border border-red-200 rounded-lg p-3 text-red-800">
                    <i class="fa-solid fa-triangle-exclamation mr-2"></i>
                    {{ cardRequestError }}
                    <button type="button" (click)="clearMessages()"
                        class="float-right text-red-600 hover:text-red-800">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>

                <!-- Info -->
                <div
                    class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-blue-800 text-sm">
                    <i class="fa-solid fa-info-circle mr-2"></i>
                    Votre demande sera traitée par un agent bancaire sous
                    24-48h.
                </div>

                <!-- Card Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Type de carte
                    </label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative cursor-pointer">
                            <input type="radio"
                                [(ngModel)]="selectedCardType"
                                value="debit"
                                name="cardType"
                                class="sr-only">
                            <div
                                [class]="selectedCardType === 'debit' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                                class="border-2 rounded-lg p-3 text-center transition-colors">
                                <i [class]="getCardTypeIcon('debit')"
                                    class="fa-solid text-2xl mb-2 text-blue-600"></i>
                                <div class="text-sm font-medium">Carte de
                                    débit</div>
                            </div>
                        </label>

                        <label class="relative cursor-pointer">
                            <input type="radio"
                                [(ngModel)]="selectedCardType"
                                value="credit"
                                name="cardType"
                                class="sr-only">
                            <div
                                [class]="selectedCardType === 'credit' ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                                class="border-2 rounded-lg p-3 text-center transition-colors">
                                <i [class]="getCardTypeIcon('credit')"
                                    class="fa-solid text-2xl mb-2 text-blue-600"></i>
                                <div class="text-sm font-medium">Carte de
                                    crédit</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Card Network -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Réseau de paiement
                    </label>
                    <div class="grid grid-cols-3 gap-2">
                        <label
                            *ngFor="let network of ['visa', 'mastercard', 'amex']"
                            class="relative cursor-pointer">
                            <input type="radio"
                                [(ngModel)]="selectedCardNetwork"
                                [value]="network"
                                name="cardNetwork"
                                class="sr-only">
                            <div
                                [class]="selectedCardNetwork === network ? 'border-blue-500 bg-blue-50' : 'border-gray-300'"
                                class="border-2 rounded-lg p-2 text-center transition-colors">
                                <i
                                    [class]="'fa-brands ' + getCardNetworkLogo(network)"
                                    class="text-2xl"></i>
                                <div
                                    class="text-xs font-medium mt-1 capitalize">{{
                                    network }}</div>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Request Reason -->
                <div>
                    <label for="requestReason"
                        class="block text-sm font-medium text-gray-700 mb-2">
                        Raison de la demande *
                    </label>
                    <textarea id="requestReason"
                        [(ngModel)]="requestReason"
                        name="requestReason"
                        rows="3"
                        placeholder="Décrivez pourquoi vous souhaitez cette carte..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        required></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-4">
                    <button type="button"
                        (click)="closeCardRequestModal()"
                        class="flex-1 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors">
                        Annuler
                    </button>

                    <button type="submit"
                        [disabled]="cardRequestLoading || !requestReason.trim()"
                        class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <span *ngIf="!cardRequestLoading">
                            <i class="fa-solid fa-paper-plane mr-2"></i>
                            Envoyer la demande
                        </span>
                        <span *ngIf="cardRequestLoading">
                            <i class="fa-solid fa-spinner fa-spin mr-2"></i>
                            Envoi en cours...
                        </span>
                    </button>
                </div>

            </form>
        </div>
    </div>

</div>